(function(L,S){typeof exports=="object"&&typeof module!="undefined"?S(exports):typeof define=="function"&&define.amd?define(["exports"],S):S((L=typeof globalThis!="undefined"?globalThis:L||self).TileMapHelper={})})(this,function(L){"use strict";var S=function(e,t){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var l in r)Object.prototype.hasOwnProperty.call(r,l)&&(i[l]=r[l])},S(e,t)};function it(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}S(e,t),e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}function H(e){var t=typeof Symbol=="function"&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var rt=function(){function e(t,i,r,l,n){this.tileWidth=t,this.tileHeight=i,this.dimX=r,this.dimY=l,this._tileSet=n,this._layers=[]}return e.prototype.getWidth=function(){return this.tileWidth*this.dimX},e.prototype.getHeight=function(){return this.tileHeight*this.dimY},e.prototype.getTileHeight=function(){return this.tileWidth},e.prototype.getTileWidth=function(){return this.tileHeight},e.prototype.getDimensionX=function(){return this.dimX},e.prototype.getDimensionY=function(){return this.dimY},e.prototype.getTileDefinition=function(t){return this._tileSet.get(t)},e.prototype.getTileDefinitions=function(){return this._tileSet.values()},e.prototype.addTileLayer=function(t){var i=new U(this,t);return this._layers.push(i),i},e.prototype.addObjectLayer=function(t){var i=new nt(this,t);return this._layers.push(i),i},e.prototype.getLayers=function(){return this._layers},e.prototype.pointIsInsideTile=function(t,i,r){var l,n,p=Math.floor(t/this.tileWidth),c=Math.floor(i/this.tileHeight);try{for(var a=H(this._layers),s=a.next();!s.done;s=a.next()){var u=s.value;if(u){var o=u.get(p,c);if(o===void 0)return!1;if(this._tileSet.get(o).hasTag(r))return!0}}}catch(y){l={error:y}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(l)throw l.error}}return!1},e}(),lt=function(){function e(t,i){this.visible=!0,this.tileMap=t,this.id=i}return e.prototype.setVisible=function(t){this.visible=t},e.prototype.isVisible=function(){return this.visible},e}(),nt=function(e){function t(i,r){var l=e.call(this,i,r)||this;return l.objects=[],l}return it(t,e),t.prototype.add=function(i){this.objects.push(i)},t}(lt),ct=function(){function e(t,i,r){this.tileId=r,this.x=t,this.y=i}return e.prototype.getTileId=function(){return M.getTileId(this.tileId)},e.prototype.setFlippedHorizontally=function(t){this.tileId=M.setFlippedHorizontally(this.tileId,t)},e.prototype.setFlippedVertically=function(t){this.tileId=M.setFlippedVertically(this.tileId,t)},e.prototype.setFlippedDiagonally=function(t){this.tileId=M.setFlippedDiagonally(this.tileId,t)},e.prototype.isFlippedHorizontally=function(){return M.isFlippedHorizontally(this.tileId)},e.prototype.isFlippedVertically=function(){return M.isFlippedVertically(this.tileId)},e.prototype.isFlippedDiagonally=function(){return M.isFlippedDiagonally(this.tileId)},e}(),M=function(){function e(){}return e.getTileId=function(t){return t&e.tileIdMask},e.setFlippedHorizontally=function(t,i){return t&=~e.flippedHorizontallyFlag,i&&(t|=e.flippedHorizontallyFlag),t},e.setFlippedVertically=function(t,i){return t&=~e.flippedVerticallyFlag,i&&(t|=e.flippedVerticallyFlag),t},e.setFlippedDiagonally=function(t,i){return t&=~e.flippedDiagonallyFlag,i&&(t|=e.flippedDiagonallyFlag),t},e.isFlippedHorizontally=function(t){return(t&e.flippedHorizontallyFlag)!=0},e.isFlippedVertically=function(t){return(t&e.flippedVerticallyFlag)!=0},e.isFlippedDiagonally=function(t){return(t&e.flippedDiagonallyFlag)!=0},e.flippedHorizontallyFlag=2147483648,e.flippedVerticallyFlag=1073741824,e.flippedDiagonallyFlag=536870912,e.tileIdMask=~(e.flippedHorizontallyFlag|e.flippedVerticallyFlag|e.flippedDiagonallyFlag),e}(),U=function(e){function t(i,r){var l=e.call(this,i,r)||this;l._tiles=[],l._tiles.length=l.tileMap.getDimensionY();for(var n=0;n<l._tiles.length;n++)l._tiles[n]=new Int32Array(l.tileMap.getDimensionX());return l}return it(t,e),t.prototype.setTile=function(i,r,l){this.tileMap.getTileDefinition(l)?this._tiles[r][i]=l+1:console.error("Invalid tile definition index: ".concat(l))},t.prototype.removeTile=function(i,r){this._tiles[r][i]=0},t.prototype.setFlippedHorizontally=function(i,r,l){var n=this._tiles[r][i];n!==0&&(this._tiles[r][i]=M.setFlippedHorizontally(n,l))},t.prototype.setFlippedVertically=function(i,r,l){var n=this._tiles[r][i];n!==0&&(this._tiles[r][i]=M.setFlippedVertically(n,l))},t.prototype.setFlippedDiagonally=function(i,r,l){var n=this._tiles[r][i];n!==0&&(this._tiles[r][i]=M.setFlippedDiagonally(n,l))},t.prototype.isFlippedHorizontally=function(i,r){return M.isFlippedHorizontally(this._tiles[r][i])},t.prototype.isFlippedVertically=function(i,r){return M.isFlippedVertically(this._tiles[r][i])},t.prototype.isFlippedDiagonally=function(i,r){return M.isFlippedDiagonally(this._tiles[r][i])},t.prototype.get=function(i,r){var l=this._tiles[r];if(l&&l[i]!==0)return M.getTileId(l[i]-1)},t.prototype.getDimensionX=function(){return this._tiles.length===0?0:this._tiles[0].length},t.prototype.getDimensionY=function(){return this._tiles.length},t.prototype.getWidth=function(){return this.tileMap.getWidth()},t.prototype.getHeight=function(){return this.tileMap.getHeight()},t}(lt),tt=function(){function e(t){this.taggedHitBoxes=[],this.animationLength=t}return e.prototype.add=function(t,i){var r=this.taggedHitBoxes.find(function(l){return l.tag===t});r||(r={tag:t,polygons:[]},this.taggedHitBoxes.push(r)),r.polygons.push(i)},e.prototype.hasTag=function(t){return this.taggedHitBoxes.some(function(i){return i.tag===t})},e.prototype.getHitBoxes=function(t){var i=this.taggedHitBoxes.find(function(r){return r.tag===t});return i&&i.polygons},e.prototype.getAnimationLength=function(){return this.animationLength},e}(),ot=function(){function e(){this._cachedValues=new Map,this._callbacks=new Map}return e.prototype.getOrLoad=function(t,i,r){var l=this,n=this._cachedValues.get(t);if(n)r(n);else{var p=this._callbacks.get(t);p?p.push(r):(this._callbacks.set(t,[r]),i(function(c){var a,s;c&&l._cachedValues.set(t,c);var u=l._callbacks.get(t);l._callbacks.delete(t);try{for(var o=H(u),y=o.next();!y.done;y=o.next())(0,y.value)(c)}catch(g){a={error:g}}finally{try{y&&!y.done&&(s=o.return)&&s.call(o)}finally{if(a)throw a.error}}}))}},e}(),ht=function(e,t){var i=t.data,r=t.compression;if(!i)return i;var l=4,n=[],p=atob(i).split("").map(function(u){return u.charCodeAt(0)});try{var c=function(u,o){return u[o]+(u[o+1]<<8)+(u[o+2]<<16)+(u[o+3]<<24)>>>0};if(r==="zlib")for(var a=new Uint8Array(p),s=e.inflate(a);l<=s.length;)n.push(c(s,l-4)),l+=4;else{if(r==="zstd")return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;l<=p.length;)n.push(c(p,l-4)),l+=4}return n}catch(u){return console.error("Failed to decompress and unzip base64 layer.data string",u),null}},at=function(e){var t=2147483648,i=1073741824,r=536870912,l=e&t,n=e&i,p=e&r;return{id:R(536870911&e),flippedHorizontally:!!l,flippedVertically:!!n,flippedDiagonally:!!p}},R=function(e){return e===0?void 0:e-1},yt=function(){function e(){}return e.load=function(t,i){var r,l,n,p,c,a,s,u,o,y;if(!i.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;var g=new Map;try{for(var F=H(i.tilesets),T=F.next();!T.done;T=F.next()){var m=T.value,_=m.firstgid===void 0?1:m.firstgid;if(m.tiles)try{for(var v=(n=void 0,H(m.tiles)),d=v.next();!d.done;d=v.next()){var h=d.value,w=new tt(h.animation?h.animation.length:0);if(h.objectgroup){var C=function(f){var et=f.class||h.class;if(!et||et.length===0)return"continue";var Z=null;if(f.polygon){var dt=f.rotation*Math.PI/180,Q=Math.cos(dt),$=Math.sin(dt);Q!==-1&&Q!==1||($=0),$!==-1&&$!==1||(Q=0),Z=f.polygon.map(function(q){return[f.x+q.x*Q-q.y*$,f.y+q.x*$+q.y*Q]})}else f.x!==void 0&&f.y!==void 0&&f.width!==void 0&&f.height!==void 0&&(Z=[[f.x,f.y],[f.x,f.y+f.height],[f.x+f.width,f.y+f.height],[f.x+f.width,f.y]]);Z&&w.add(et,Z)};try{for(var P=(c=void 0,H(h.objectgroup.objects)),I=P.next();!I.done;I=P.next())C(G=I.value)}catch(f){c={error:f}}finally{try{I&&!I.done&&(a=P.return)&&a.call(P)}finally{if(c)throw c.error}}}else if(h.class&&h.class.length>0){var X=[[0,0],[0,i.tileheight],[i.tilewidth,i.tileheight],[i.tilewidth,0]];w.add(h.class,X)}g.set(R(_+h.id),w)}}catch(f){n={error:f}}finally{try{d&&!d.done&&(p=v.return)&&p.call(v)}finally{if(n)throw n.error}}for(var k=0;k<m.tilecount;k++){var B=R(_+k);g.has(B)||g.set(B,new tt(0))}}}catch(f){r={error:f}}finally{try{T&&!T.done&&(l=F.return)&&l.call(F)}finally{if(r)throw r.error}}var j=new rt(i.tilewidth,i.tileheight,i.width,i.height,g);try{for(var b=H(i.layers),V=b.next();!V.done;V=b.next()){var x=V.value;if(x.type==="objectgroup"){var W=j.addObjectLayer(x.id);W.setVisible(x.visible);try{for(var z=(o=void 0,H(x.objects)),D=z.next();!D.done;D=z.next()){var Y=D.value;if(Y.visible&&Y.gid){var O=at(Y.gid),G=new ct(Y.x,Y.y,O.id);W.add(G),G.setFlippedHorizontally(O.flippedHorizontally),G.setFlippedVertically(O.flippedVertically),G.setFlippedDiagonally(O.flippedDiagonally)}}}catch(f){o={error:f}}finally{try{D&&!D.done&&(y=z.return)&&y.call(z)}finally{if(o)throw o.error}}}else if(x.type==="tilelayer"){var ft=0,K=null;if(x.encoding==="base64"?(K=ht(t,x))||console.warn("Failed to uncompress layer.data"):K=x.data,K){var J=j.addTileLayer(x.id);J.setVisible(x.visible);for(var E=0;E<x.height;E++)for(var A=0;A<x.width;A++){var xt=K[ft],N=at(xt);N.id!==void 0&&(J.setTile(A,E,N.id),J.setFlippedHorizontally(A,E,N.flippedHorizontally),J.setFlippedVertically(A,E,N.flippedVertically),J.setFlippedDiagonally(A,E,N.flippedDiagonally)),ft+=1}}}}}catch(f){s={error:f}}finally{try{V&&!V.done&&(u=b.return)&&u.call(b)}finally{if(s)throw s.error}}return j},e}(),gt=GlobalPIXIModule.PIXI,st=function(){function e(){this._textures=new Map}return e.prototype.setTexture=function(t,i,r,l,n){var p=this._getGlobalId(t,i,r,l);this._textures.set(p,n)},e.prototype.findTileTexture=function(t,i,r,l){var n=this._getGlobalId(t,i,r,l);if(this._textures.has(n))return this._textures.get(n);var p=this._textures.get(t);if(p){var c=p.frame.clone(),a=p.orig.clone();if(l){var s=a.width;a.width=a.height,a.height=s}var u=a.clone(),o=0;l?(o=10,!i&&r?o=2:i&&!r?o=6:i&&r&&(o=14)):(o=0,!i&&r?o=8:i&&!r?o=12:i&&r&&(o=4));var y=new gt.Texture(p.baseTexture,c,a,u,o);return this._textures.set(n,y),y}},e.prototype._getGlobalId=function(t,i,r,l){var n=t;return i&&(n|=e.flippedHorizontallyFlag),r&&(n|=e.flippedVerticallyFlag),l&&(n|=e.flippedDiagonallyFlag),n},e.flippedHorizontallyFlag=2147483648,e.flippedVerticallyFlag=1073741824,e.flippedDiagonallyFlag=536870912,e}(),pt=GlobalPIXIModule.PIXI,ut=function(){function e(){}return e.parseAtlas=function(t,i,r){if(!t.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!t.tilesets.length||"source"in t.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;var l=t.tilesets[0],n=l.tilewidth,p=l.tileheight,c=l.tilecount,a=l.image,s=l.columns,u=l.spacing,o=l.margin,y=l.firstgid===void 0?1:l.firstgid;i||(i=r(a));var g=c/s,F=n*s+u*(s-1)+2*o,T=p*g+u*(g-1)+2*o;if(i.width!==1&&F!==i.width||i.height!==1&&T!==i.height){var m=F+"x"+T,_=i.width+"x"+i.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+m+"px, but it's "+_+" px."),null}for(var v=new st,d=0;d<c;d++){var h=o+Math.floor(d%s)*(n+u),w=o+Math.floor(d/s)*(p+u),C=R(y+d);try{var P=new pt.Rectangle(h,w,n,p),I=new pt.Texture(i,P);v.setTexture(C,!1,!1,!1,I)}catch(X){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",X)}}return v},e.updatePixiTileMap=function(t,i,r,l,n){var p,c,a,s,u=t;if(u){u.clear();try{for(var o=H(i.getLayers()),y=o.next();!y.done;y=o.next()){var g=y.value;if(l==="index"&&n!==g.id||l==="visible"&&!g.isVisible())return;if(g instanceof nt){var F=g;try{for(var T=(a=void 0,H(F.objects)),m=T.next();!m.done;m=T.next()){var _=m.value,v=r.findTileTexture(_.getTileId(),_.isFlippedHorizontally(),_.isFlippedVertically(),_.isFlippedDiagonally());v&&u.addFrame(v,_.x,_.y-F.tileMap.getTileHeight())}}catch(b){a={error:b}}finally{try{m&&!m.done&&(s=T.return)&&s.call(T)}finally{if(a)throw a.error}}}else if(g instanceof U)for(var d=g,h=0;h<d.tileMap.getDimensionY();h++)for(var w=0;w<d.tileMap.getDimensionX();w++){var C=d.tileMap.getTileWidth(),P=C*w,I=d.tileMap.getTileHeight()*h,X=d.get(w,h);if(X!==void 0){var k=r.findTileTexture(X,d.isFlippedHorizontally(w,h),d.isFlippedVertically(w,h),d.isFlippedDiagonally(w,h));if(k){var B=u.addFrame(k,P,I),j=d.tileMap.getTileDefinition(X);j&&j.getAnimationLength()>0&&B.tileAnimX(C,j.getAnimationLength())}}}}}catch(b){p={error:b}}finally{try{y&&!y.done&&(c=o.return)&&c.call(o)}finally{if(p)throw p.error}}}},e.updatePixiCollisionMask=function(t,i,r,l,n,p,c,a){var s,u,o,y;if(t){t.clear();try{for(var g=H(i.getLayers()),F=g.next();!F.done;F=g.next()){var T=F.value,m=i.getTileWidth(),_=i.getTileHeight();if(T instanceof U)for(var v=T,d=0;d<v.tileMap.getDimensionY();d++)for(var h=0;h<v.tileMap.getDimensionX();h++){var w=m*h,C=_*d,P=v.get(h,d),I=v.isFlippedHorizontally(h,d),X=v.isFlippedVertically(h,d),k=v.isFlippedDiagonally(h,d),B=v.tileMap.getTileDefinition(P);if(B){var j=B.getHitBoxes(r);if(j){t.lineStyle(l,n,p);try{for(var b=(o=void 0,H(j)),V=b.next();!V.done;V=b.next()){var x=V.value;if(x.length!==0){t.beginFill(c,a);for(var W=0;W<x.length;W++){var z=x[W][0],D=x[W][1];if(I&&(z=m-z),X&&(D=_-D),k){var Y=z;z=D,D=Y}W===0?t.moveTo(w+z,C+D):t.lineTo(w+z,C+D)}t.closePath(),t.endFill()}}}catch(O){o={error:O}}finally{try{V&&!V.done&&(y=b.return)&&y.call(b)}finally{if(o)throw o.error}}}}}}}catch(O){s={error:O}}finally{try{F&&!F.done&&(u=g.return)&&u.call(g)}finally{if(s)throw s.error}}}},e}(),vt=function(){function e(){this._tileMapCache=new ot,this._textureCacheCaches=new ot}return e.getManager=function(t){return t.tileMapCollisionMaskManager||(t.tileMapCollisionMaskManager=new e),t.tileMapCollisionMaskManager},e.prototype.getOrLoadTileMap=function(t,i,r,l,n){var p=i+"|"+r;this._tileMapCache.getOrLoad(p,function(c){t(i,r,function(a){if(a){var s=yt.load(l,a);c(s)}else c(null)})},n)},e.prototype.getOrLoadTextureCache=function(t,i,r,l,n,p){var c=l+"|"+n+"|"+r;this._textureCacheCaches.getOrLoad(c,function(a){t(l,n,function(s){if(s){var u=r?i(r):null,o=ut.parseAtlas(s,u,i);a(o)}else a(null)})},p)},e}();L.EditableTileMap=rt,L.EditableTileMapLayer=U,L.PixiTileMapHelper=ut,L.TileDefinition=tt,L.TileMapManager=vt,L.TileTextureCache=st,Object.defineProperty(L,"__esModule",{value:!0})});
//# sourceMappingURL=TileMapHelper.js.map
